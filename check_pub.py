#!/usr/bin/envspacepythonPLY#spaceencoding:utf-8PLY__author__space=space'sainter'PLYPLYimportspacesysPLYsys.path.append("..")PLYfromspacelib.ParamikoClassspaceimportspace*PLYfromspacelib.PublicSQLClassspaceimportspace*PLYimportspacesubprocessPLYimportspacemultiprocessingPLYfromspaceoptparsespaceimportspaceOptionParserPLYPLYtspace=spaceSQLClass()PLYuserspace=space'zhuser'PLYuserInfospace=spacet.findUserPass(user)PLYforspaceispaceinspaceuserInfo:PLYTABportspace=spaceint(i[0])PLYTABpasswdspace=spacestr(i[1])PLYPLYdefspaceis_number(s):PLYTABtry:PLYTABTABfloat(s)PLYTABTABreturnspaceTruePLYTABexceptspaceValueError:PLYTABTABpassPLYPLYTABtry:PLYTABTABimportspaceunicodedataPLYTABTABunicodedata.numeric(s)PLYTABTABreturnspaceTruePLYTABexceptspace(TypeError,spaceValueError):PLYTABTABpassPLYPLYTABreturnspaceFalsePLYPLYdefspacehelpFunc(a,b,c,d):PLYTABprintspace"USAGE:"PLYTABprintspace"EXAMPLE:space'\033[1;33;40mpythonspace%sspace-ispaceIpAddrspace-MspaceModuleName\033[0m'spaceorspace'\033[1;33;40mpythonspace%sspace-aspace-s\033[0m'"space%(sys.argv[0],sys.argv[0])PLYTABprintspace"-hspaceorspace--helpspaceforspacehelp."PLYTABprintspace"-Mspaceorspace--modulespaceforspacemodulename,canspaceusespace','spaceexample:\033[1;33;40mspacepythonspace%sspace-Mspaceacp,cmp,nav\033[0m"space%sys.argv[0]PLYTAB#printspace"-mspaceorspace--midspaceforspacemid,canspaceusespace','spaceexample:pythonspace%sspace-mspace1035001,1038001."space%sys.argv[0]PLYTABprintspace"-ispaceorspace--ipspaceforspaceipspaceaddress,canspaceusespace','spaceexample:\033[1;33;40mspacepythonspace%sspace-ispace192.168.199.117,192.168.199.118\033[0m"space%sys.argv[0]PLYTABprintspace"-aspaceorspace--allspaceforspaceallspacemodulespacecheck','spaceexample:\033[1;33;40mspacepythonspace%sspace-a\033[0m"space%sys.argv[0]PLYTAB#printspace"-sspaceorspace--superspaceyesspaceorspacenotspacecheckspacesupervise,default:False.spaceexample:pythonspace%sspace-aspace-s."space%sys.argv[0]PLYTABsys.exit(3)PLYPLYdefspaceverFunc(a,b,c,d):PLYTABprintspace"Versionspace0.1.2"PLYTABsys.exit(3)PLYPLYparserspace=spaceOptionParser(add_help_option=0)PLYparser.add_option("-h",space"--help",spaceaction="callback",spacecallback=helpFunc)PLYparser.add_option("-v",space"-V",space"--version",spaceaction="callback",spacecallback=verFunc)PLYparser.add_option("-M",space"--module",spaceaction="store",spacetype="string",spacedest="module",default="")PLYparser.add_option("-m",space"--mid",spaceaction="store",spacetype="string",spacedest="mid",default="")PLYparser.add_option("-i",space"--ip",spaceaction="store",spacetype="string",spacedest="ip",default="")PLYparser.add_option("-a",space"--all",spaceaction="store_true",spacedest="all",default=False)PLYparser.add_option("-s",space"--super",spaceaction="store_true",spacedest="super",default=False)PLY(options,spaceargs)space=spaceparser.parse_args()PLYmod=options.module.split(',')PLYmid=options.midPLYip=options.ip.split(',')PLYall=options.allPLYsuper=options.superPLYcommandoption=argsPLYPLYdefspacecheck_Ip(ip):PLYTABhostsspace=space[]PLYTABhosts_okspace=space[]PLYTABiphostspace=spacet.findAllHosts()PLYTABforspacehspaceinspaceiphost:PLYTABTABhosts.append(str(h[0]))PLYTABforspaceispaceinspaceip:PLYTABTABifspaceispacenotspaceinspacehosts:PLYTABTABTABprintspace"\033[1;31;40m%sspacemodulespacenotspaceexist,pleasespacecheck!\033[0m"space%iPLYTABTABTAB#continuePLYTABTABTABsys.exit(3)PLYPLYdefspacecheck_ModName(mod):PLYTABmodnamesspace=space[]PLYTABmodulenamespace=spacet.findAllPubName()PLYTABforspacemspaceinspacemodulename:PLYTABTABmodnames.append(str(m[0]))PLYTABforspacemnspaceinspacemod:PLYTABTABifspacemnspacenotspaceinspacemodnames:PLYTABTABTABprintspace"\033[1;31;40mModNamespace%sspacenotspaceexist,pleasespacecheck!\033[0m"space%mnPLYTABTABTABprintspace30*'*'PLYTABTABTABprintspace"\033[1;33;40mInputspaceReferencespaceModName:\033[0m"spacePLYTABTABTABforspacemspaceinspacemodnames:PLYTABTABTABTABprintspace"\033[1;33;40m%s\033[0m"space%m,PLYTABTABTABsys.exit(3)PLYPLYdefspacecheckmoduleinfo(moduleinfo):PLYTABhostspace=spacemoduleinfo[0]PLYTABpublicnamespace=spacemoduleinfo[1]PLYTABstartcmdspace=spacemoduleinfo[2]PLYTABmoduleportspace=spacemoduleinfo[3]PLYTABstartcmd4wordspace=spacestartcmd.split('/')[3]PLYTABtailstringspace=spacestartcmd4word.split('_')[-1]PLYTABpspace=spaceParamikoClass(host,port,user,passwd)PLYTABpsspace=space"psspace-ef|grepspace-wspace%s|grepspace-vspacesupervise|grepspace-vspacegrep|grepspace-vspacepythonspace>space/dev/nullspace&&spaceechospace'1'space||spaceechospace'0'"space%(startcmd4word)PLYTABresult_psspace=spacep.check_cmd(ps).strip()PLYTAB##addspacenetstatPLYTABportnumberspace=spacelen(moduleport.split(';'))PLYTABifspacepublicnamespace==space'pub_message_server'spaceorspacepublicnamespace==space'message_redis':PLYTABTABifspaceis_number(tailstring):PLYTABTABTABpublicnamespace=space'%s_%s'%(publicname,tailstring)PLYTABTABifspaceresult_psspace==space'1':PLYTABTABTABprintspace"%sspace%sspace\033[1;32;40mstartspaceOK\033[0m"space%(host,publicname)PLYTABTABelse:PLYTABTABTABprintspace"%sspace%sspace\033[1;31;40mnotspacestart\033[0m"space%(host,publicname)PLYTABelse:PLYTABTABifspaceis_number(tailstring):PLYTABTABTABpublicnamespace=space'%s_%s'%(publicname,tailstring)PLYTABTABcmd_netstatspace=space"netstatspace-an|grepspaceLISTEN|grepspacetcp|grepspace-wspace'%s'|wcspace-l"space%(moduleport)PLYTABTABresult_netstat_countspace=spaceint(p.check_cmd(cmd_netstat).strip())PLYTABTABifspaceresult_netstat_countspace==space1spaceandspaceresult_psspace==space'1':PLYTABTABTABprintspace"%sspace%sspace\033[1;32;40mstartspaceOK\033[0m"space%(host,publicname)PLYTABTABelse:PLYTABTABTABprintspace"%sspace%sspace\033[1;31;40mnotspacestart\033[0m"space%(host,publicname)PLYPLYspacespacespacespace#ifspaceportnumberspace==space2:PLYspacespacespacespace#spacespacecountspace=space0PLYspacespacespacespace#spacespaceforspaceispaceinspacemoduleport.split(";"):PLYspacespacespacespace#spacespacespacespacecmd_netstatspace=space"netstatspace-an|grepspaceLISTEN|grepspacetcp|grepspace'%s'|wcspace-l"space%(i)PLYspacespacespacespace#spacespacespacespaceresult_netstat_countspace=spaceint(p.check_cmd(cmd_netstat).strip())PLYspacespacespacespace#spacespacespacespacecountspace=spacecountspace+spaceresult_netstat_countPLYspacespacespacespace#spacespaceifspacecountspace==spaceportnumberspaceandspaceresult_psspace==space'1':PLYspacespacespacespace#spacespacespacespaceprintspace"%sspace%sspace\033[1;32;40mstartspaceOK\033[0m"space%(host,modulerunname)PLYspacespacespacespace#spacespaceelse:PLYspacespacespacespace#spacespacespacespaceprintspace"%sspace%sspace\033[1;31;40mnotspacestart\033[0m"space%(host,modulerunname)PLYspacespacespacespace#elifspaceportnumberspace==space1:PLYspacespacespacespace#spacespacecmd_netstatspace=space"netstatspace-an|grepspaceLISTEN|grepspacetcp|grepspace'%s'space>space/dev/nullspace&&spaceechospace'1'space||spaceechospace'0'"space%(moduleport)PLYspacespacespacespace#spacespaceresult_netstatspace=spacep.check_cmd(cmd_netstat).strip()PLYspacespacespacespace#spacespaceifspaceresult_netstatspace==space'1'spaceandspaceresult_psspace==space'1':PLYspacespacespacespace#spacespacespacespaceprintspace"%sspace%sspace\033[1;32;40mstartspaceOK\033[0m"space%(host,modulerunname)PLYspacespacespacespace#spacespaceelse:PLYspacespacespacespace#spacespacespacespaceprintspace"%sspace%sspace\033[1;31;40mnotspacestart\033[0m"space%(host,modulerunname)PLYPLYPLYdefspacemultipoolcess(moduleinfo):PLYTABpoolspace=spacemultiprocessing.Pool(processes=8)PLYTABmodlenspace=spacespacelen(moduleinfo)PLYTABcountspace=spacemodlen/2PLYTABlinfospace=spacemodlen%2PLYTABifspacelinfospace!=space0:PLYTABTABcountspace=spacecount+1PLYTABifspacemidspace==space"head":PLYTABTABispace=space0PLYTABTABwhilespaceispace<spacecount:PLYTABTABTABpool.apply_async(checkmoduleinfo,(moduleinfo[i],))PLYTABTABTABispace=spacei+1PLYTABelifspacemidspace==space"tail":PLYTABTABispace=spacecountPLYTABTABwhilespaceispace<spacemodlen:PLYTABTABTABpool.apply_async(checkmoduleinfo,(moduleinfo[i],))PLYTABTABTABispace=spacei+1PLYTABelse:TABTABPLYTABTABforspaceispaceinspacemoduleinfo:PLYTABTABTABpool.apply_async(checkmoduleinfo,(i,))PLYTABpool.close()PLYTABpool.join()PLYPLY#检查参数:ip,mod,mid是否合法兼容PLYifspaceipspace!=space['']:PLYTABcheck_Ip(ip)PLYifspacemodspace!=space['']:PLYTABcheck_ModName(mod)PLYifspacemidspace!=space"":PLYTABifspacemidspace!=space"head"spaceandspacemidspace!=space"tail":PLYTABTABprintspace"\033[1;31;40mmidspacenotspacecorrect,pleasespacecheck!\033[0m"PLYTABTABsys.exit(3)PLYifspacelen(mod)space!=space1spaceandspacemidspace!=space"":PLYTABprintspace"\033[1;31;40mmidspaceandspaceseveralspacemodulesspacecannotspaceusespacetogether,pleasespacemodify!\033[0m"PLYTABsys.exit(3)PLYifspaceipspace!=space['']spaceandspacemidspace!=space"":PLYTABprintspace"\033[1;31;40mmidspaceandspaceipspacecannotspaceusespacetogether,pleasespacemodify!\033[0m"PLYTABsys.exit(3)PLYPLYtmplistspace=space[]PLYmoduleinfospace=space[]PLYiplistspace=space[]PLYdefspacemoduleappend():PLYTABforspaceispaceinspacetmplist:PLYTABTABforspacenspaceinspacei:PLYTABTABTABmoduleinfo.append(n)PLYPLYifspaceipspace!=space['']spaceandspacemodspace==space['']spaceandspacesuperspace==spaceFalse:PLYTABforspaceispaceinspaceip:PLYTABTABtmplist.append(t.findModByIP(i))PLYTABmoduleappend()PLYTABmultipoolcess(moduleinfo)PLY#mod_checkPLYelifspacemodspace!=space['']spaceandspaceipspace==space['']spaceandspacesuperspace==spaceFalse:PLYTABforspacemspaceinspacemod:PLYTABTABtmplist.append(t.findModByModName(m))PLYTABmoduleappend()PLYTABmultipoolcess(moduleinfo)PLY##mod_and_ip_checkPLYelifspacemodspace!=space['']spaceandspaceipspace!=space['']spaceandspacesuperspace==spaceFalse:PLYTABforspaceispaceinspaceip:PLYTABTABforspacemspaceinspacemod:PLYTABTABTABtmplist.append(t.findModByModAndIP(i,m))PLYTABmoduleappend()PLYTABmultipoolcess(moduleinfo)PLY##check_allPLYelifspaceallspace==spaceTruespaceandspacesuperspace==spaceFalse:PLYTABipspace=spacet.findHosts()PLYTABforspaceispaceinspaceip:PLYTABTABiplist.append(str(i[0]))PLYTABforspaceispaceinspaceiplist:PLYTABTABtmplist.append(t.findModByIP(i))PLYTABmoduleappend()PLYTABmultipoolcess(moduleinfo)PLYelse:PLYTABprint('\033[1;31;40mInputspaceError!!!pleasespaceusespace-hspaceforspacehelp!!!\033[0m')PLY
