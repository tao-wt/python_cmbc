#!/usr/bin/envspacepythonPLY#spaceencoding:utf-8PLYPLYPLYimportspacesysPLYimportspaceosPLYsys.path.append("..")PLYfromspacelib.LogicSQLClassspaceimportspace*PLYfromspacelib.ParamikoClassspaceimportspace*PLYimportspacerespacePLYimportspacemultiprocessingPLYfromspaceoptparsespaceimportspaceOptionParserPLYimportspacetimePLYPLYdefspacehelpFunc(a,b,c,d):PLYTABprintspace"\033[32;1mForspacehelp:"PLYTABprintspace"superstar.pyspace[-aspace(Allspaceip)space-ispace(IPspaceaddress,xx1,xx2..)space-Mspace(Modulespacename)space-sspace(Superspacemode)space-cspace(start|stop)]"PLYTABprintspace"superstar.pyspace-aspace-cspacestart|stopspace--allspace--cmdspacestart|stop"PLYTABprintspace"superstar.pyspace-ispaceipaddr,[xx,xx]space-cspacestart|stopspace--ipspacex1,x2,..space--cmdspacestart|stop"PLYTABprintspace"superstar.pyspace-Mspacemodulename,[xx,xx]space-cspacestart|stopspace--Modspacemod1,mod2space--cmdspacestart|stop"PLYTABprintspace"superstar.pyspace-ispaceipaddr,[xx,xx]space-Mspacemodulename,[xx,xx]space-cspacestart|stop"PLYTABprintspace"-nspaceorspace--numberspaceforspaceCPname."PLYTABprintspace'''---------------------------------------------------------------------------------------PLYForspaceexamples:PLY1spaceforspacegeneralspaceusage:PLYspacespacepythonspacesuperstar.pyspace-aspace-cspacestartPLYspacespacepythonspacesuperstar.pyspace-Mspacelogspace-cspacestartPLYspacespacepythonspacesuperstar.pyspace-ispace192.168.199.117,192.168.199.118space-cspacestartPLYspacespacepythonspacesuperstar.pyspace-ispace192.168.199.117,192.168.199.118space-Mspacelogspace-cspacestartPLY---------------------------------------------------------------------------------------\033[0m'''PLYdefspacecheck_Ip(ip):PLYTABhostsspace=space[]PLYTABhosts_okspace=space[]PLYTABiphostspace=spacet.findHosts()PLYTABforspacehspaceinspaceiphost:PLYTABTABhosts.append(str(h[0]))PLYTABipspace=space{}.fromkeys(ip).keys()PLYTABforspaceispaceinspaceip:PLYTABTABifspaceispacenotspaceinspacehosts:PLYTABTABTABprintspace"\033[1;31;40m%sspacenotspaceexist,pleasespacecheck!\033[0m"space%iPLYTABTABTAB#continuePLYTABTABTABsys.exit(3)PLYPLYdefspacecheck_ModName(mod):PLYTABmodnamesspace=space[]PLYTABmodulenamespace=spacet.findModName()PLYTABforspacemspaceinspacemodulename:PLYTABTABmodnames.append(str(m[0]))PLYTABforspacemnspaceinspacemod:PLYTABTABifspacemnspacenotspaceinspacemodnames:PLYTABTABTABprintspace"\033[1;31;40mModNamespace%sspacenotspaceexist,pleasespacecheck!\033[0m"space%mnPLYTABTABTABprintspace30*'*'PLYTABTABTABprintspace"\033[1;33;40mInputspaceReferencespaceModName:\033[0m"spacePLYTABTABTABforspacemspaceinspacemodnames:PLYTABTABTABTABprintspace"\033[1;33;40m%s\033[0m"space%m,PLYTABTABTABsys.exit(3)PLYPLYifspacelen(sys.argv)space!=space1:PLYspacespacespacespacespacespacespacespaceifspace"-"spaceinspacesys.argv:PLYspacespacespacespacespacespacespacespacespacespacespacespacespacespacespacespaceprintspace"\033[1;31;40merrorspaceargv:-,pleasespacemodify!\033[0m"PLYspacespacespacespacespacespacespacespacespacespacespacespacespacespacespacespacesys.exit(3)PLYparserspace=spaceOptionParser(add_help_option=0)PLYparser.add_option("-h",space"--help",spaceaction="callback",spacecallback=helpFunc)PLYparser.add_option("-c",space"--cmd",spaceaction="store",spacetype="string",spacedest="cmd",default="")PLYparser.add_option("-a",space"--all",spaceaction="store_true",spacedest="all")PLYparser.add_option("-i",space"--ip",spaceaction="store",spacetype="string",spacedest="ip",spacedefault="")PLYparser.add_option("-M",space"--Mod",spaceaction="store",spacetype="string",spacedest="modname",spacedefault="")PLYparser.add_option("-m",space"--mid",spaceaction="store",spacetype="string",spacedest="mid",default="")PLYparser.add_option("-n",space"--number",spaceaction="store",spacetype="string",spacedest="number",default="")PLYparser.add_option("-f",space"--force",spaceaction="store_true",spacedest="killforce")PLYPLY(options,spaceargs)space=spaceparser.parse_args()PLYruncmd=options.cmdPLYrunall=options.allPLYrunip=options.ipPLYrunmod=options.modnamePLYmid=options.midPLYorder=options.number.split(',')PLYcommandoption=argsPLYkillforce=options.killforcePLYnum=8PLYPLYtspace=spaceSQLClass()PLYPLY#获取数据库中机器的用户名，端口和密码PLYuserInfospace=spacet.findUserPass('zhuser')PLYforspaceispaceinspaceuserInfo:PLYTABuserspace=spacei[0]PLYTABportspace=spaceint(i[1])PLYTABpasswdspace=spacei[2]PLYPLY#启停所有模块函数,传入IP参数启停该机器上所有模块，除supervise进程外。spaceBEGINPLYPLY#启动configcenter模块。PLYdefspacestartAll(ip):PLYTABloginspace=spaceParamikoClass(ip[0],port,user,passwd)PLYTABforspacemdspaceinspacet.findipConfPath(ip[0]):PLYTABTABmodule=md[0].strip().split("/")[-1]PLYTABTABcmd="cdspace%s;bashspacestartAndStop.shspacestartspace%s;exit;"space%(md[0],module)PLYTABTABlogin.cmd_run(cmd)PLYTABTABprintspace"\033[32;1m%sspace:space%sspaceisspaceok\033[0m"space%(ip[0],module)PLYPLY#启动除configcenter之外的所有模块PLYdefspacestartAllother(ip):PLYTABspaceloginspace=spaceParamikoClass(ip[0],port,user,passwd)PLYTABspaceforspacemdspaceinspacet.findipOtherPath(ip[0]):PLYTABTABmodule=md[0].strip().split("/")[-1]PLYTABTABcmd="cdspace%s;bashspacestartAndStop.shspacestartspace%s;exit;"space%(md[0],module)PLYTABTABlogin.cmd_run(cmd)PLYTABTABprintspace"\033[32;1m%sspace:space%sspaceisspaceok\033[0m"space%(ip[0],module)PLYPLY#停掉机器上所有模块PLYdefspacestopAll(ip):PLYTABloginspace=spaceParamikoClass(ip[0],port,user,passwd)PLYTABifspacekillforcespace==spaceTruespace:PLYTABTABstopforce="-9"PLYTABelse:PLYTABTABstopforce=""PLYTABcmd="psspace-ef|grepspace'/home/zhuser/jdk1.7.0_25/bin/java'|grepspace-vspacegrep|awkspace'{printspace$2}'|xargsspacekillspace%sspace"%stopforcePLYTABlogin.cmd_run(cmd)PLYTABprintspace"\033[31;1mspace%sspacehasspacebeenspacekilled.\033[0m"space%(ip[0])PLY#启停所有模块函数spaceENDPLYPLYPLY#启停指定IP地址的函数spaceBEGINPLYdefspacefor_specified_ip(ip):PLYTABloginspace=spaceParamikoClass(ip,port,user,passwd)PLYTABifspaceruncmdspace==space"start":PLYTABTABforspacemdspaceinspacet.findipConfPath(ip):PLYTABTABTABmodule=md[0].strip().split("/")[-1]PLYTABTABTABcmd="cdspace%s;bashspacestartAndStop.shspacestartspace%s;exit;"space%(md[0],module)PLYTABTABTABlogin.cmd_run(cmd)PLYTABTABTABprintspace"\033[32;1m%sspace:space%sspaceisspaceok\033[0m"space%(ip,module)PLYTABTABtime.sleep(5)PLYTABTABforspacemdspaceinspacet.findipOtherPath(ip):PLYTABTABTABmodule=md[0].strip().split("/")[-1]PLYTABTABTABcmd="cdspace%s;bashspacestartAndStop.shspacestartspace%s;exit;"space%(md[0],module)PLYTABTABTABlogin.cmd_run(cmd)PLYTABTABTABprintspace"\033[32;1m%sspace:space%sspaceisspaceok\033[0m"space%(ip,module)PLYTABelse:PLYTABTABifspacekillforcespace==spaceTruespace:PLYTABTABTABstopforce="-9"PLYTABTABelse:PLYTABTABTABstopforce=""PLYTABTABcmd="psspace-ef|grepspace'/home/zhuser/jdk1.7.0_25/bin/java'|grepspace-vspacegrep|awkspace'{printspace$2}'|xargsspacekillspace%sspace"%stopforcePLYTABTABlogin.cmd_run(cmd)PLYTABTABprintspace"\033[31;1mspace%sspacehasspacebeenspacekilled.\033[0m"space%(ip)PLYPLY#启动指定模块的函数PLYdefspacestartOrStopMod(j):PLYTABipspace=spacej[0]PLYTABmodPathspace=spacej[1]PLYTABloginspace=spaceParamikoClass(ip,port,user,passwd)PLYTABmodule=modPath.strip().split("/")[-1]PLYTABifspaceruncmdspace==space"start":PLYTABTABcmd="cdspace%s;bashspacestartAndStop.shspacestartspace%s;exit;"space%(modPath,module)PLYTABelse:PLYTABTABifspacekillforcespace==spaceTruespace:PLYTABTABTABstopforce="-9"PLYTABTABelse:PLYTABTABTABstopforce=""PLYTABTABcmd="psspace-efspace|spacegrepspace'/home/zhuser/jdk1.7.0_25/bin/java'space|spacegrepspace'\-jarspace%s.jar'space|spacegrepspace-vspacegrepspace|spaceawkspace'{printspace$2}'space|spacexargsspace-nspace1space-ispacekillspace%sspace{};"%(module,stopforce)PLYTABlogin.cmd_run(cmd)PLYTABprintspace"\033[32;1m%sspace:space%sspaceisspace%sspaceok\033[0m"space%(ip,module,runcmd)PLYPLYdefspacerunApp():#启停所有服务的函数PLYTABifspaceruncmdspace==space"start":PLYTABTABforspaceipspaceinspacet.findHosts():PLYTABTABTABstartAll(ip)PLYTABTABtime.sleep(6)PLYPLYTABTABpoolspace=spacemultiprocessing.Pool(processes=num)PLYTABTABforspaceipspaceinspacet.findHosts():PLYTABTABTABpool.apply_async(startAllother,(ip,))PLYTABTABpool.close()PLYTABTABpool.join()PLYPLYTABelse:PLYTABTABpoolspace=spacemultiprocessing.Pool(processes=num)PLYTABTABforspaceipspaceinspacet.findHosts():PLYTABTABTABpool.apply_async(stopAll,(ip,))PLYTABTABpool.close()PLYTABTABpool.join()PLYPLYdefspacerun_some():space#指定IP地址启停的函数PLYTABpoolspace=spacemultiprocessing.Pool(processes=num)PLYTABforspaceipspaceinspaceinput_ip_list:PLYTABTABifspaceipspaceinspaceall_ip_list:PLYTABTABTABpool.apply_async(for_specified_ip,(ip,))PLYTABTABelse:PLYTABTABTABprintspace"[\033[33;1m%sspaceisspacenotspaceexist\033[0m]"space%(ip)PLYTABpool.close()PLYTABpool.join()PLYPLYpoolspace=spacemultiprocessing.Pool(processes=num)#指定并发进程数量PLYinput_ip_list=runip.strip().split(',')space#获取-i给出的IP地址列表PLYall_ip_list=[]#IP列表PLYinput_mod_list=runmod.strip().split(',')#取出参数中所有的模块PLYsomemod=[]PLYinfolistspace=space[]PLYdefspacemoduleappend(list):PLYTABnewListspace=space[]PLYTABforspaceispaceinspacelist:PLYTABTABforspacenspaceinspacei:PLYTABTABTABnewList.append(n)PLYTABreturnspacenewListPLYPLY#检查参数:ip,mod,mid是否合法兼容PLYifspaceinput_ip_listspace!=space['']:PLYTABcheck_Ip(input_ip_list)PLYifspaceinput_mod_listspace!=space['']:PLYTABcheck_ModName(input_mod_list)PLYifspacemidspace!=space"":PLYTABifspacemidspace!=space"head"spaceandspacemidspace!=space"tail":PLYTABTABprintspace"\033[1;31;40mmidspacenotspacecorrect,pleasespacecheck!\033[0m"PLYTABTABsys.exit(3)PLYifspaceruncmdspace!=space"":PLYTABifspaceruncmdspace!=space"stop"spaceandspaceruncmdspace!=space"start":PLYTABTABprintspace"\033[1;31;40mcmdspacenotspacecorrect,pleasespacecheck!\033[0m"PLYTABTABsys.exit(3)PLYelse:PLYTABprintspace"\033[1;31;40mcmdspacemustspacehave,pleasespacecheck!\033[0m"PLYTABsys.exit(3)PLYifspaceorderspace!=space['']:PLYTABorder_newspace=spaceorderPLYTABorderspace=space['']PLYTABforspacei,jspaceinspaceenumerate(order_new):PLYTABTABjspace=spacere.sub(r'[a-zA-Z]*',"",j,0)PLYTABTABifspacej.find("-",0,len(j))space!=space-1:PLYTABTABTAB#spacejspace=spacej.upper().replace("CP","")PLYTABTABTABoj=j.split('-')PLYTABTABTABforspaceiobjspaceinspacerange(int(oj[0]),int(oj[1])+1):PLYTABTABTABTABorder.append("CP%s"%iobj)PLYTABTABelse:PLYTABTABTABorder.append("CP%s"%j)PLYTABTABTAB#spaceorder.append(order_new[i].upper())PLYPLY#spaceifspacelen(input_mod_list)space!=space1spaceandspacemidspace!=space"":PLYTAB#spaceprintspace"\033[1;31;40mmidspaceandspaceseveralspacemodulesspacecannotspaceusespacetogether,pleasespacemodify!\033[0m"PLYTAB#spacesys.exit(3)PLYifspacelen(input_mod_list)space!=space1spaceandspaceorderspace!=space['']:PLYTABprintspace"\033[1;31;40morderspaceandspaceseveralspacemodulesspacecannotspaceusespacetogether,pleasespacemodify!\033[0m"PLYTABsys.exit(3)PLYifspaceinput_ip_listspace!=space['']spaceandspacemidspace!=space"":PLYTABprintspace"\033[1;31;40mmidspaceandspaceipspacecannotspaceusespacetogether,pleasespacemodify!\033[0m"PLYTABsys.exit(3)PLYifspaceorderspace!=space['']spaceandspacemidspace!=space"":PLYTABprintspace"\033[1;31;40mmidspaceandspaceorderspacenumberspacecannotspaceusespacetogether,pleasespacemodify!\033[0m"PLYTABsys.exit(3)PLYifspaceorderspace!=space['']spaceandspaceinput_ip_listspace!=space['']:PLYTABprintspace"\033[1;31;40mipspaceandspaceorderspacenumberspacecannotspaceusespacetogether,pleasespacemodify!\033[0m"PLYTABsys.exit(3)PLYPLY#普通模式(不带supervise)PLYifspacelen(input_mod_list[0])space!=space0spaceandspacelen(input_ip_list[0])space!=space0:#如果指定了IP地址，命令start和模块名。PLYTABforspacespaceipspaceinspaceinput_ip_list:PLYTABTABforspacemodspaceinspaceinput_mod_list:PLYTABTABTABsomemod.append(t.QTfindPath(mod,ip))PLYTABinfolistspace=spacemoduleappend(somemod)PLYTABifspaceinfolistspace!=space[]:TABTABPLYTABTABforspaceispaceinspaceinfolist:PLYTABTABTABpool.apply_async(startOrStopMod,(i,))PLYTABTABpool.close()PLYTABTABpool.join()PLYTABelse:PLYTABTABprint('Error!pleasespacecheckspacedbspacefile!!')PLYelifspacelen(input_mod_list[0])space!=space0spaceandspacespacelen(input_ip_list[0])space==space0:#如果指定了模块名字和命令start。PLYTABorderStrspace=space""PLYTABifspaceorderspace!=space['']:PLYTABTABorderStrspace=space"spaceandspace("PLYTABTABforspacenspaceinspaceorder:PLYTABTABTABorderStrspace=spaceorderStrspace+space"CPname='%s'spaceorspace"%nPLYTABTABorderStrspace=spacere.sub(r'spaceorspace$',")",orderStr,0)PLYTABforspaceispaceinspaceinput_mod_list:PLYTABTABgetListspace=space[]PLYTABTABgetList.append(t.QTfindIp(i,orderStr))PLYTABTABlistspace=spacemoduleappend(getList)PLYTABTABmodlenspace=spacespacelen(list)PLYTABTABcountspace=spacemodlen/2PLYTABTABlinfospace=spacemodlen%2PLYTABTABifspacelinfospace!=space0:PLYTABTABTABcountspace=spacecount+1PLYTABTABifspacemidspace==space"head":PLYTABTABTABispace=space0PLYTABTABTABwhilespaceispace<spacecount:PLYTABTABTABTABinfolist.append(list[i])PLYTABTABTABTABispace=spacei+1PLYTABTABelifspacemidspace==space"tail":PLYTABTABTABispace=spacecountPLYTABTABTABwhilespaceispace<spacemodlen:PLYTABTABTABTABinfolist.append(list[i])PLYTABTABTABTABispace=spacei+1PLYTABTABelse:PLYTABTABTABforspaceispaceinspacelist:PLYTABTABTABTABinfolist.append(i)PLYTABifspaceinfolistspace!=space[]:PLYTABTABforspaceispaceinspaceinfolist:PLYTABTABTABpool.apply_async(startOrStopMod,(i,))PLYTABTABpool.close()PLYTABTABpool.join()PLYTABelse:PLYTABTABprint('Error!pleasespacecheckspacedbspacefile!!')PLYelifspacelen(input_ip_list[0])space!=space0spaceandspacelen(input_mod_list[0])space==space0:space#只指定IP地址PLYTABforspaceispaceinspacet.findHosts():PLYTABTABall_ip_list.append(str(i[0]))PLYTABrun_some()PLYPLYelifspacerunallspace==spaceTrue:#指定-a，runall为true，执行所有操作PLYTABrunApp()PLYPLYelse:PLYTABhelpFunc('a','b','c','d')
