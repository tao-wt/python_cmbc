#!/usr/bin/envspacepythonPLY#spaceencoding:utf-8PLY__author__space=space'Chocolee'PLYimportspacesysPLYsys.path.append("..")PLYfromspacelib.LogicSQLClassspaceimportspace*PLYfromspacelib.ParamikoClassspaceimportspace*PLYfromspaceoptparsespaceimportspaceOptionParserPLYimportspacemultiprocessingPLYimportspacerePLYPLYtspace=spaceSQLClass()PLY#申明使用哪个用户操作远程设备PLYuseUserspace=space'zhuser'PLYappSourcePathspace=space'/home/zhuser/innerapp'PLYprocessNum=10PLYuserInfospace=spacet.findUserPass(useUser)PLYforspaceispaceinspaceuserInfo:PLYTABuserspace=spacei[0]PLYTABportspace=spacei[1]PLYTABpasswdspace=spacei[2]PLYPLYdefspacecheck_Ip(ip):PLYTABhostsspace=space[]PLYTABhosts_okspace=space[]PLYTABiphostspace=spacet.findHosts()PLYTABforspacehspaceinspaceiphost:PLYTABTABhosts.append(str(h[0]))PLYTABipspace=space{}.fromkeys(ip).keys()PLYTABforspaceispaceinspaceip:PLYTABTABifspaceispacenotspaceinspacehosts:PLYTABTABTABprintspace"\033[1;31;40m%sspacenotspaceexist,pleasespacecheck!\033[0m"space%iPLYTABTABTAB#continuePLYTABTABTABsys.exit(3)PLYPLYdefspacecheck_ModName(mod):PLYTABmodnamesspace=space[]PLYTABmodulenamespace=spacet.findModName()PLYTABforspacemspaceinspacemodulename:PLYTABTABmodnames.append(str(m[0]))PLYTABforspacemnspaceinspacemod:PLYTABTABifspacemnspacenotspaceinspacemodnames:PLYTABTABTABprintspace"\033[1;31;40mModNamespace%sspacenotspaceexist,pleasespacecheck!\033[0m"space%mnPLYTABTABTABprintspace30*'*'PLYTABTABTABprintspace"\033[1;33;40mInputspaceReferencespaceModName:\033[0m"spacePLYTABTABTABforspacemspaceinspacemodnames:PLYTABTABTABTABprintspace"\033[1;33;40m%s\033[0m"space%m,PLYTABTABTABsys.exit(3)PLYPLY#创建程序目录PLYdefspacemkWebappDir(host):PLYTABpspace=spaceParamikoClass(host,port,user,passwd)PLYTABp.cmd_run('mkdirspace-pspace/opt/innerapp')PLYPLYdefspacemkSupDir(host):PLYTABpspace=spaceParamikoClass(host,port,user,passwd)PLYTABp.cmd_run('mkdirspace-pspace/opt/supervise')PLYPLY#帮助信息PLYdefspacehelpFunc(a,b,c,d):PLYTABprintspace"USAGE:"PLYTABprintspace"-hspaceorspace--helpspaceforspacehelp."PLYTABprintspace"-Mspaceorspace--modulespaceforspacemodulename,canspaceusespace','spaceexample:acp,cmp,nav."PLYTABprintspace"-ispaceorspace--ipspaceforspaceipspaceaddress,canspaceusespace','spaceexample:192.168.199.11,10.10.10.10."PLYTABprintspace"-aspaceorspace--allspaceforspaceallspaceipspaceaddress,listspaceofspacedb."PLYTABprintspace"-Dspaceorspace--deployappspaceforspacedeployspaceallspaceapp,usespacethisspaceoptionspacemustspacebespacecareful!"PLYTABprintspace"-nspaceorspace--numberspaceforspaceCPname."PLYTABprintspace"EXAMPLE:space'pythonspace%sspace-ispace10.10.10.10space-Mspaceacp'"space%sys.argv[0]PLYTABsys.exit(3)PLYPLY#远程推送配置文件PLYdefspacesendAndConf(infoList):PLYTABhostspace=spaceinfoList[0]PLYTABmnamespace=spaceinfoList[1]PLYTABpathspace=spaceinfoList[2]PLYTABcpnamespace=spaceinfoList[3]PLYTABtmpspace=spacepath.split('/')PLYTABfilenamespace=spacetmp[-1]PLYTABdjob_numberspace=spacepath.split('_')[-1]PLYTABpspace=spaceParamikoClass(host,port,user,passwd)PLYTABlocal_dirspace=space'%s/%s/'space%(appSourcePath,mname)PLYTABremote_dirspace=space'%s/'space%pathPLYTABdircmd=space"rmspace-rfspace%s%s*"%(remote_dir,mname)PLYTABp.cmd_run(dircmd)PLYTABp.upload(local_dir,remote_dir)PLYTABifspacemname=="djob":PLYTABTABcmdspace=space"sedspace-ispace'/ComputerName/spaces#CP01#%s#g'space%s/servicesetting.properties;sedspace-ispace's/^\(org.quartz.scheduler.instanceId:\).*/\\1instance_%s/'space%s/quartz.properties"space%(cpname,path,djob_number,path)PLYTABelse:PLYTABTABcmdspace=space"sedspace-ispace'/ComputerName/spaces#CP01#%s#g'space%s/servicesetting.properties"space%(cpname,path)PLYTABp.cmd_run(cmd)PLYTABcmdspace=space"cdspace%s;mvspace%s.jarspace%s.jar"space%(path,mname,filename)PLYTABp.cmd_run(cmd)PLYTABprint('%sspace:uploadspace%sspace\033[1;32;40mOK\033[0m'%(host,filename))PLYPLYdefspacemkdirWebapp():PLYTABpoolspace=spacemultiprocessing.Pool(processes=processNum)PLYTABhostlistspace=spacet.findHosts()PLYTABforspaceispaceinspacehostlist:PLYTABTABpool.apply_async(mkWebappDir,(i[0],))PLYTABpool.close()PLYTABpool.join()PLYPLY#部署模块PLYdefspacedeployRun():PLYTABpoolspace=spacemultiprocessing.Pool(processes=processNum)PLYTABlistinfospace=spacet.sendFileInfo()PLYTABforspaceispaceinspacelistinfo:PLYTABTABpool.apply_async(sendAndConf,(i,))PLYTABpool.close()PLYTABpool.join()PLYPLY#申明帮助参数属性PLYparserspace=spaceOptionParser(add_help_option=0)PLYparser.add_option("-h",space"--help",spaceaction="callback",spacecallback=helpFunc)PLYparser.add_option("-M",space"--module",spaceaction="store",spacetype="string",spacedest="module",default="")PLYparser.add_option("-m",space"--mid",spaceaction="store",spacetype="string",spacedest="mid",default="")PLYparser.add_option("-i",space"--ip",spaceaction="store",spacetype="string",spacedest="ip",default="")PLYparser.add_option("-a",space"--all",spaceaction="store_true",spacedest="all")PLYparser.add_option("-D",space"--deployapp",spaceaction="store_true",spacedest="deployapp")PLYparser.add_option("-n",space"--number",spaceaction="store",spacetype="string",spacedest="number",default="")PLYparser.add_option("-C",space"--changefile",spaceaction="store",spacetype="string",spacedest="cfilename",default="")PLY(options,spaceargs)space=spaceparser.parse_args()PLYipspace=spaceoptions.ip.split(',')PLYmodspace=spaceoptions.module.split(',')PLYmid=options.midPLYallipspace=spaceoptions.allPLYdeployappspace=spaceoptions.deployappPLYorder=options.number.split(',')PLYcfilenamespace=spaceoptions.cfilenamePLYcommandoption=argsPLYPLYdefspacemultipoolcess(infolist):PLYTABpoolspace=spacemultiprocessing.Pool(processes=processNum)PLYTABmodlenspace=spacespacelen(infolist)PLYTABcountspace=spacemodlen/2PLYTABlinfospace=spacemodlen%2PLYTABifspacelinfospace!=space0:PLYTABTABcountspace=spacecount+1PLYTABifspacemidspace==space"head":PLYTABTABispace=space0PLYTABTABwhilespaceispace<spacecount:PLYTABTABTABpool.apply_async(sendAndConf,(infolist[i],))PLYTABTABTABispace=spacei+1PLYTABelifspacemidspace==space"tail":PLYTABTABispace=spacecountPLYTABTABwhilespaceispace<spacemodlen:PLYTABTABTABpool.apply_async(sendAndConf,(infolist[i],))PLYTABTABTABispace=spacei+1PLYTABelse:TABTABPLYTABTABforspaceispaceinspaceinfolist:PLYTABTABTABpool.apply_async(sendAndConf,(i,))PLYTABpool.close()PLYTABpool.join()PLYPLYifspace__name__space==space'__main__':PLYTABifspacelen(sys.argv)space==space1:PLYTABTABhelpFunc('a','b','c','d')PLYTAB#获取模块列表和ip列表PLYTABmodulelistspace=space[]PLYTABiplistspace=space[]PLYTABtmpspace=spacet.findModName()PLYTABforspaceispaceinspacetmp:PLYTABTABmodulelist.append(str(i[0]))PLYTABtmpspace=spacet.findHosts()PLYTABforspaceispaceinspacetmp:PLYTABTABiplist.append(str(i[0]))PLYTABifspaceipspace!=space['']:PLYTABTABcheck_Ip(ip)PLYTABifspacemodspace!=space['']:PLYTABTABcheck_ModName(mod)PLYTABifspaceorderspace!=space['']:PLYTABTABallipspace=spaceTruePLYTABTABorder_newspace=spaceorderPLYTABTABorderspace=space['']PLYTABTABforspacei,jspaceinspaceenumerate(order_new):PLYTABTABTABjspace=spacere.sub(r'[a-zA-Z]*',"",j,0)PLYTABTABTABifspacej.find("-",0,len(j))space!=space-1:PLYTABTABTABTAB#spacejspace=spacej.upper().replace("CP","")PLYTABTABTABTABoj=j.split('-')PLYTABTABTABTABforspaceiobjspaceinspacerange(int(oj[0]),int(oj[1])+1):PLYTABTABTABTABTABorder.append("CP%s"%iobj)PLYTABTABTABelse:PLYTABTABTABTABorder.append("CP%s"%j)PLYTABTABTABTAB#spaceorder.append(order_new[i].upper())PLYTABifspacemidspace!=space"":PLYTABTABifspacemidspace!=space"head"spaceandspacemidspace!=space"tail":PLYTABTABTABprintspace"\033[1;31;40mmidspacenotspacecorrect,pleasespacecheck!\033[0m"PLYTABTABTABsys.exit(3)PLYTABTABelse:PLYTABTABTABallipspace=spaceTruePLYTABifspacelen(mod)space!=space1spaceandspaceorderspace!=space['']:PLYTABTABprintspace"\033[1;31;40morderspaceandspaceseveralspacemodulesspacecannotspaceusespacetogether,pleasespacemodify!\033[0m"PLYTABTABsys.exit(3)PLYTABifspacelen(mod)space!=space1spaceandspacemidspace!=space"":PLYTABTABprintspace"\033[1;31;40mmidspaceandspaceseveralspacemodulesspacecannotspaceusespacetogether,pleasespacemodify!\033[0m"PLYTABTABsys.exit(3)PLYTABifspaceipspace!=space['']spaceandspacemidspace!=space"":PLYTABTABprintspace"\033[1;31;40mmidspaceandspaceipspacecannotspaceusespacetogether,pleasespacemodify!\033[0m"PLYTABTABsys.exit(3)PLYTABifspaceorderspace!=space['']spaceandspacemidspace!=space"":PLYTABTABprintspace"\033[1;31;40mmidspaceandspaceorderspacenumberspacecannotspaceusespacetogether,pleasespacemodify!\033[0m"PLYTABTABsys.exit(3)PLYTABifspaceorderspace!=space['']spaceandspaceipspace!=space['']:PLYTABTABprintspace"\033[1;31;40mipspaceandspaceorderspacenumberspacecannotspaceusespacetogether,pleasespacemodify!\033[0m"PLYTABTABsys.exit(3)PLYTABPLY#判断输入的ip及模块名称是否合法，是否存在在配置文件中。PLYTABifspacemodspace!=space['']spaceandspaceipspace!=space['']:PLYTABTABtmplistspace=space[]PLYTABTABinfolistspace=space[]PLYTABTABforspaceispaceinspacemod:PLYTABTABTABforspacenspaceinspaceip:PLYTABTABTABTABtmplist.append(t.findIpModInfo(n,i))PLYTABTABwhilespace[]spaceinspacetmplist:PLYTABTABTABtmplist.remove([])PLYTABTABforspaceispaceinspacetmplist:PLYTABTABTABforspacenspaceinspacei:PLYTABTABTABTABinfolist.append(n)PLYTABTABifspaceinfolistspace!=space[]:PLYTABTABTABmultipoolcess(infolist)PLYTABTABelse:PLYTABTABTABprint('Error!pleasespacecheckspacedbspacefile!!')PLY#对模块进行批量部署，更新模块也是这一判断PLYTABelifspacemodspace!=space['']spaceandspaceallipspace==spaceTrue:PLYTABTABorderStrspace=space""PLYTABTABifspaceorderspace!=space['']:PLYTABTABTABorderStrspace=space"spaceandspace("PLYTABTABTABforspacenspaceinspaceorder:PLYTABTABTABTABorderStrspace=spaceorderStrspace+space"CPname='%s'spaceorspace"%nPLYTABTABTABorderStrspace=spacere.sub(r'spaceorspace$',"",orderStr,0)space+space")"PLYTABTABtmplistspace=space[]PLYTABTABinfolistspace=space[]PLYTABTABforspaceispaceinspacemod:PLYTABTABTABtmplist.append(t.findIPInfo(i,orderStr))PLYTABTABforspaceispaceinspacetmplist:PLYTABTABTABforspacenspaceinspacei:PLYTABTABTABTABinfolist.append(n)PLYTABTABifspaceinfolistspace!=space[]:PLYTABTABTABmultipoolcess(infolist)PLYTABTABelse:PLYTABTABTABprint('Error!pleasespacecheckspacedbspacefile!!')PLYTABelifspacecfilenamespace!=space['']:PLYTABTABAllIpPath=t.FindAllIpPath()PLYTABTABtheIp=AllIpPath[1][1]PLYTABTABCpspace=spaceParamikoClass(theIp,port,user,passwd)PLYTABTABforspaceispaceinspaceAllIpPath:PLYTABTABTABifspacetheIpspace!=spacei[0]:PLYTABTABTABTABprintspace"+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++"PLYTABTABTABTABtheIpspace=spacei[0]PLYTABTABTABTABCpspace=spaceParamikoClass(theIp,port,user,passwd)PLYTABTABTABpathspace=spacei[1]PLYTABTABTABlocal_filespace=space'%s'space%cfilenamePLYTABTABTABremote_dirspace=space'%s/'space%pathPLYTABTABTABCp.put_file(local_file,remote_dir)PLY#部署所有模块PLYTABelifspacedeployapp:PLYTABTABinfospace=spaceraw_input('Arespaceyouspacesurespaceusespacethisspaceoption(yes/no):')PLYTABTABifspaceinfospace==space'yes':PLYTABTABTABmkdirWebapp()PLYTABTABTABdeployRun()PLYTABTABelifspaceinfospace==space'no':PLYTABTABTABsys.exit(3)PLYTABTABelse:PLYTABTABTABprintspace'Sorry,mustspacechoicespaceyesspaceorspaceno.'PLYTABelse:PLYTABTABprint('syntaxspaceerror!Pleasespaceusespace-hspaceforspacehelp!')PLY
