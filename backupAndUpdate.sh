#!/bin/envspacebashPLY#spacewriterspaceSY60216PLY#space脚本功能：版本的备份与更新space须1个目标版本参数(绝对路径)PLY#spaceusage：spacePLY#TABTABTABbashspacebackupAndUpdate.shspace"/sourcePath/(filename|dirname)"PLYPLYIFS=$'space\t\n'PLYsource=$1PLYiuser=$(whoami)PLYechospaceuserspaceis:$iuserPLYtypesetspace-lspacemod;typesetspace-lspacepub;PLYmodError1="";pubError1="";modfinish="";pubfinish="";modCheckOk="";pubCheckOk="";PLYmodError2="";modError3="";modsum=0;pubsum=0;PLYpubError2="";pubError3=""PLYPLYmod_check(){PLYTABifspace[space-dspace"/home/$iuser/innerapp/${1}"space];thenPLYTABTABreturnspace0PLYTABelsePLYTABTABreturnspace1PLYTABfiPLY}PLYpub_check(){PLYTABifspace[space-dspace"/home/$iuser/webhome/${1}"space];thenPLYTABTABreturnspace0PLYTABelsePLYTABTABreturnspace1PLYTABfiPLY}PLYPLYbackupAndupdate_mod(){PLYTAB#依据mod_lib文件夹备份和更新mod版本PLYTABechospace=======================${1}===============================PLYTABlocalspaceresult=0PLYTABechospacestartspacebackupspacethespacemodulespace:space$1PLYTABmkdirspace-pspace/home/$iuser/backup/bak_$(datespace+%F)/$1PLYTABfindspace/home/$iuser/innerapp/space-namespace${1}.jarspace|spacexargsspace-n1space-ispace-tspacemvspace-fspace{}space/home/$iuser/backup/bak_$(datespace+%F)/${1}/space||spaceresult=2PLYTABfindspace/home/$iuser/innerapp/space-namespace${1}_libspace-typespacedspace|spacexargsspace-n1space-ispace-tspacemvspace-fspace{}space/home/$iuser/backup/bak_$(datespace+%F)/${1}/space||spaceresult=2PLYTABifspace[space$resultspace-eqspace0space]PLYTABthenPLYTABTABechospace$1spacebackupspacesuccess,nowspacestartingspaceupdate...PLYTABTABfindspace/tmp/$(datespace+%m%d)/$dirname/space-namespace${1}.jarspace-typespacefspace|spacexargsspace-n1space-ispace-tspacecpspace{}space/home/$iuser/innerapp/${1}/space||spaceresult=3PLYTABTABfindspace/tmp/$(datespace+%m%d)/$dirname/space-namespace${1}_libspace-typespacedspace|spacexargsspace-n1space-ispace-tspacecpspace-rspace{}space/home/$iuser/innerapp/${1}/space||spaceresult=3PLYTABTABifspace[space$resultspace-eqspace0space]PLYTABTABthenPLYTABTABTABechospace$1spaceupdatespacesuccess!PLYTABTABfiPLYTABelsePLYTABTABechospace$1spacebackupspacefailed!PLYTABfiPLYTABreturnspace$resultPLY}PLYPLYbackupAndupdate_pub(){PLYTAB#根据war包,备份与更新订阅号平台PLYTABwhilespacetestspace$#space-gtspace1PLYTABdoPLYTABTABechospace=======================${1}===============================PLYTABTABlocalspaceresult=0PLYTABTABifspace[space"X$2"space=space"Xwebmanager"space];thenPLYTABTABTABechospacebackupspacewebmanagerspaceconfigspacefiles.PLYTABTABTABpushdspace/home/$iuser/webhome/$2space>/dev/nullPLYTABTABTABTABzipspace-qspace../webmanagerConf.zipspace./dbconfiglogger.propertiesspace./dbconfig.propertiesspace./webmgr.propertiesspace./WEB-INF/classes/dbconfig.propertiesspace./WEB-INF/classes/config/spring.xmlPLYTABTABTABpopdspace>/dev/nullPLYTABTABTABechospacebackupspacefinish.PLYTABTABfiPLYTABTABechospacestartspacebackupspacethespacepubspace:space$2PLYTABTABfindspace/home/$iuser/webhome/space-maxdepthspace1space-namespace${2}space-typespacedspace2>/dev/nullspace|spacexargsspace-n1space-ispace-tspacemvspace-fspace{}space/home/$iuser/backup/bak_$(datespace+%F)/space||spaceresult=2PLYTABTABifspace[space$resultspace-eqspace0space]PLYTABTABthenPLYTABTABTABechospace$1spacebackupspacesuccess,nowspacestartingspaceupdate...PLYTABTABTABfindspace/tmp/$(datespace+%m%d)/$dirname/space-namespace"${1}.*war"space-typespacefspace|spacexargsspace-n1space-ispace-tspaceunzipspace-ospace{}space-dspace/home/$iuser/webhome/$2/space>/dev/nullspace||spaceresult=3PLYTABTABTABfindspace/tmp/$(datespace+%m%d)/$dirname/space-namespace"${1}.*war"space-typespacefspace|spacexargsspace-n1space-ispace-tspacecpspace{}space/home/$iuser/webhome/${2}/PLYTABTABTABifspace[space$resultspace-eqspace0space]PLYTABTABTABthenPLYTABTABTABTABifspace[space"X$2"space=space"Xwebmanager"space];thenPLYTABTABTABTABTABechospaceupdatespacewebmanagerspaceconfigspacefiles.PLYTABTABTABTABTABpushdspace/home/$iuser/webhome/$2space>/dev/nullPLYTABTABTABTABTABTABunzipspace-qspace-ospace../webmanagerConf.zipspace-dspace.PLYTABTABTABTABTABpopdspace>/dev/nullPLYTABTABTABTABTABechospaceupdatespacefinish.PLYTABTABTABTABfiPLYTABTABTABTABechospace$1spaceupdatespacesuccess!PLYTABTABTABfiPLYTABTABelsePLYTABTABTABechospace$1spacebackupspacefailed!PLYTABTABfiPLYTABTABcasespace$resultspaceinPLYTABTABTAB2)PLYTABTABTABTABpubError2=${pubError2}","$2PLYTABTABTABTAB;;PLYTABTABTAB3)PLYTABTABTABTABpubError3=${pubError3}","$2PLYTABTABTABTAB;;PLYTABTABTAB0)PLYTABTABTABTABpubfinish=${pubfinish}","$2PLYTABTABTABTAB;;PLYTABTABesacPLYTABTABshiftspace2PLYTABdonePLYTAB#spacereturnspace$resultPLY}PLYPLY#确定新版本所在文件夹的名字.PLYsource2=${source%/}PLYfileName=${source2##/*/}PLYdirname=${fileName%%.*}PLYechospacenewspaceversionspacefilespacenamespaceis:$dirnamePLYPLY#创建版本备份与更新目录PLYifspace[space!space-zspace"$dirname"space];thenPLYTABifspace[space!space-dspace"/tmp/$(datespace+%m%d)"space]PLYTABthenPLYTABTABechospacemkdirspace/tmp/$(datespace+%m%d)/$dirnamePLYTABTABmkdirspace-pspace/tmp/$(datespace+%m%d)/$dirnamePLYTABelsePLYTABTABechospacedir:/tmp/$(datespace+%m%d)/$dirnamespaceexist,deletespaceit!PLYTABTABrmspace-rfspace/tmp/$(datespace+%m%d)/$dirname/*PLYTABfiPLYelsePLYTABechospace$sourcespacehavespaceerror!spacecheckspace!PLYTABexitspace1PLYfiPLYifspace[space!space-dspace"/home/$iuser/backup/bak_$(datespace+%F)"space]PLYthenPLYTABechospacemkdirspace/home/$iuser/backup/bak_$(datespace+%F)PLYTABmkdirspace/home/$iuser/backup/bak_$(datespace+%F)PLYelsePLYTABechospacedir:/home/$iuser/backup/bak_$(datespace+%F)spaceexist,deletespaceit!PLYTABrmspace-rfspace/home/$iuser/backup/bak_$(datespace+%F)/*PLYfiPLYPLY#解压新版本并把新版本放到指定目录:(datespace+%m%d)PLYifspace[space-fspace"$source"space]PLYthenPLYTABfilespace$sourcespace|spacegrepspace"Zipspacearchivespacedata"space>/dev/nullspace2>&1space&&space{PLYTABTABechospaceExtractingspace$sourcePLYTABTABunzipspace-ospace$sourcespace-dspace/tmp/$(datespace+%m%d)/$dirnamespace>/dev/nullspace&&spaceechospaceExtractspacefinish.PLYTAB}PLYfiPLYifspace[space-dspace"$source"space]PLYthenPLYTABechospace$sourcespace|spacegrepspace"/tmp/$(datespace+%m%d)"space>/dev/nullspace2>&1space||space{PLYTABTABechospacecpspace$dirnamespacetospace/tmp/$(datespace+%m%d)/$dirnamePLYTABTABcpspace-rspace${source%/}/*space/tmp/$(datespace+%m%d)/$dirnamespacespace&&spaceechospacecopyspacefinish.PLYTAB}PLYfiPLYPLY#开始版本备份与更新PLYpushdspace/tmp/$(datespace+%m%d)/$dirnamespace>/dev/nullPLYTABforspaceimodspaceinspace$(findspace.space-namespace"*_lib"space-typespacedspace|spaceawkspace-Fspace"/"space'{printspace$NF}'space|spaceawkspace-Fspace"_"space'{printspace$1}')PLYTABdoPLYTABTABmod_checkspace$imodPLYTABTABcasespace$?spaceinPLYTABTABTAB1)PLYTABTABTABTABmodError2=${modError1}","$imodPLYTABTABTABTAB;;PLYTABTABTAB0)PLYTABTABTABTABmodCheckOk=${modCheckOk}"space"$imodPLYTABTABTABTAB;;PLYTABTABesacPLYTABdonePLYTABforspaceipubspaceinspace$(findspace.space-namespace"*.war"space-typespacefspace|spaceawkspace-Fspace"/"space'{printspace$NF}'space|spaceawkspace-Fspace"."space'{printspace$1}')PLYTABdoPLYTABTABpubdirname=pub_errorPLYTABTABpub=$ipub;PLYTABTABcasespace$pubspaceinPLYTABTABTAB*live*control*)PLYTABTABTABTABpubdirname="livecontrol"PLYTABTABTABTAB;;PLYTABTABTAB*live*interface*)PLYTABTABTABTABpubdirname="liveinterface"PLYTABTABTABTAB;;PLYTABTABTAB*live*room*)PLYTABTABTABTABpubdirname="liveroom"PLYTABTABTABTAB;;PLYTABTABTAB*cmbc*interface*)PLYTABTABTABTABpubdirname="pub_cmbc_interface"PLYTABTABTABTAB;;PLYTABTABTAB*webmanager*)PLYTABTABTABTABpubdirname="webmanager"PLYTABTABTABTAB;;PLYTABTABesacPLYTABTABpub_checkspace$pubdirnamePLYTABTABcasespace$?spaceinPLYTABTABTAB1)PLYTABTABTABTABpubError1=${pubError1}","$pubPLYTABTABTABTAB;;PLYTABTABTAB0)PLYTABTABTABTABpubCheckOk=${pubCheckOk}"space"$pub"space"$pubdirnamePLYTABTABTABTAB;;PLYTABTABesacPLYTABdonePLYTABechospacecheckspaceresult:PLYTABifspace[space!space-zspace"$modError1"space];thenPLYTABTABechospacemodspacenamespaceerror:$modError1PLYTABfiPLYTABifspace[space!space-zspace"$pubError1"space];thenPLYTABTABechospacepubspacenamespaceerror:$pubError1PLYTABfiPLYTABifspace[space!space-zspace"$modCheckOk"space];thenPLYTABTABechospacemodspacenamespaceok:$modCheckOkPLYTABfiPLYTABifspace[space!space-zspace"$pubCheckOk"space];thenPLYTABTABechospacepubspacenamespaceok:$pubCheckOkPLYTABfiPLYTABechospacepleasespaceconfirmspacethespaceresultspaceandspaceenterspaceyes/nospacetospacecontinue...PLYTABreadspacexPLYTABifspace[space"X$x"space=space"Xyes"space];thenPLYTABTABforspacemspaceinspace$modCheckOkPLYTABTABdoPLYTABTABTAB#echospacemod:$((++modsum)),$mPLYTABTABTABbackupAndupdate_modspace$mPLYTABTABTABcasespace$?spaceinPLYTABTABTABTAB2)PLYTABTABTABTABTABmodError2=${modError2}","$mPLYTABTABTABTABTAB;;PLYTABTABTABTAB3)PLYTABTABTABTABTABmodError3=${modError3}","$mPLYTABTABTABTABTAB;;PLYTABTABTABTAB0)PLYTABTABTABTABTABmodfinish=${modfinish}","$mPLYTABTABTABTABTAB;;PLYTABTABTABesacPLYTABTABdonePLYTABTABbackupAndupdate_pubspace$(echospace$pubCheckOk)PLYTABelsePLYTABTABexitspace1PLYTABfiPLYpopdspace>/dev/nullPLYPLY#最后结果输出PLYechospace==========================================================PLY#spaceechospacemodspacetotalspaceis:${modsum},pubspacetotalspaceis:${pubsum}PLYifspace[space!space-zspace"$modError1"space];thenPLYTABechospacemodspacenamespaceerror:$modError1PLYfiPLYifspace[space!space-zspace"$modError2"space]PLYthenPLYTABechospacemodspacebackupspacefailedspacehave:$modError2PLYfispacePLYifspace[space!space-zspace"$modError3"space];thenPLYTABechospacemodspaceupdatespacefailedspacehave:$modError3PLYfispacePLYifspace[space!space-zspace"$pubError1"space];thenPLYTABechospacepubspacenamespaceerror:$pubError1PLYfiPLYifspace[space!space-zspace"$pubError2"space]PLYthenPLYTABechospacepubspacebackupspacefailedspacehave:$pubError2PLYfiPLYifspace[space!space-zspace"$pubError2"space];thenPLYTABechospacepubspaceupdatespacefailedspacehave:$pubError3PLYfiPLYechospacemod:${modfinish}spacefinish!PLYechospacepub:${pubfinish}spacefinish!PLYexit
